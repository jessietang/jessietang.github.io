<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实现一个简单的监听订阅者模式 | Jessie's Blog</title>
    <meta name="description" content="实现该模式需要提前搞清楚的点：  监听订阅者模式是什么？  如果要自己实现，应该怎么样去实现？  一个事件可以注册多个不同的处理事件函数，应该怎么存放数据？  一个事件有多个处理函数，怎么进行选择性取消？（注册的时候，返回一个取消注册，每次注册的时候，把需要选择取消的返回函数收集起来统一执行就可以进行取消）直接上...">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="alternate" type="application/atom+xml" title="Jessie's Blog Feed" href="/feed.xml">
</head>
<body>
    <header class="site-header">
        <div class="container">
            <h1 class="site-title"><a href="/">Jessie's Blog</a></h1>
            <nav class="site-nav">
                <ul>
                    <li><a href="/">首页</a></li>
                    <li><a href="/blog/">博客</a></li>
                    <li><a href="/about/">关于</a></li>
                    <li><a href="/categories/">分类</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <article class="post">
    <header class="post-header">
        <h1 class="post-title">实现一个简单的监听订阅者模式</h1>
        <div class="post-meta">
            <time datetime="2022-04-30T00:00:00+08:00">2022年04月30日</time>
            
            <span class="post-categories">
                
                <a href="/categories/#面试合集">面试合集</a>
                , 
                
                <a href="/categories/#零散的知识点积累">零散的知识点积累</a>
                
                
            </span>
            
        </div>
    </header>

    <div class="post-content">
        <h4 id="实现该模式需要提前搞清楚的点">实现该模式需要提前搞清楚的点：</h4>
<ol>
  <li>监听订阅者模式是什么？</li>
  <li>如果要自己实现，应该怎么样去实现？</li>
  <li>一个事件可以注册多个不同的处理事件函数，应该怎么存放数据？</li>
  <li>一个事件有多个处理函数，怎么进行选择性取消？（注册的时候，返回一个取消注册，每次注册的时候，把需要选择取消的返回函数收集起来统一执行就可以进行取消）</li>
</ol>

<p>直接上代码啊：</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nf">EasyEventEmitter</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">notifys</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="c1">// 满足正则匹配 * </span>
  <span class="kd">let</span> <span class="nx">notifyAnys</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">let</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="kd">const</span> <span class="nx">del</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">fun</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">cacheNotify</span> <span class="o">=</span> <span class="nf">getCacheByKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">fun</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="nx">cacheNotify</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="c1">// 没有指定fun，则删除全部</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">ls</span> <span class="o">=</span> <span class="nx">cacheNotify</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">ls</span> <span class="o">&amp;&amp;</span> <span class="nx">ls</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">ls</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">a</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">ls</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span> <span class="o">===</span> <span class="nx">fun</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">ls</span><span class="p">.</span><span class="nf">splice</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="k">break</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nf">getCacheByKey</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
    <span class="k">return</span> <span class="sr">/</span><span class="se">\*</span><span class="sr">/</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">?</span> <span class="nx">notifyAnys</span> <span class="p">:</span> <span class="nx">notifys</span>
  <span class="p">}</span>

  <span class="c1">// on的时候，进行注册，每注册一个，生成对象的一个key/value, value是数组，如果key相同，则value数组进行push handler。</span>
  <span class="c1">// on函数返回当前注册这个事件名称的取消注册函数。</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">fun</span><span class="p">,</span> <span class="nx">isOnly</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">cacheNotify</span> <span class="o">=</span> <span class="nf">getCacheByKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  
    <span class="nx">cacheNotify</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cacheNotify</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">||</span> <span class="p">[]</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">isOnly</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cacheNotify</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="nx">cacheNotify</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nf">push</span><span class="p">(</span><span class="nx">fun</span><span class="p">)</span>

    <span class="c1">// 返回取消注册函数</span>
    <span class="k">return </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nf">del</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">fun</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// onOnce内部执行on这个方法，并且接受返回值unOff方法，然后执行调用onOff.</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">onOnce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">fun</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">unOff</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nf">fun</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span>
      <span class="nf">unOff</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">ls</span> <span class="o">=</span> <span class="nx">notifys</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

    <span class="c1">// * </span>
    <span class="kd">let</span> <span class="nx">anys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">notifyAnys</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">anys</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
      <span class="kd">let</span> <span class="nx">newLs</span><span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">anys</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="k">new</span> <span class="nc">RegExp</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nf">test</span><span class="p">(</span><span class="nx">key</span><span class="p">)){</span>
          <span class="nx">newLs</span><span class="p">.</span><span class="nf">push</span><span class="p">(...</span><span class="nx">notifyAnys</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">newLs</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">ls</span><span class="p">){</span>
          <span class="nx">newLs</span><span class="p">.</span><span class="nf">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,...</span><span class="nx">ls</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">ls</span> <span class="o">=</span> <span class="nx">newLs</span>
      <span class="p">}</span>
    <span class="p">}</span>
   
    <span class="k">if </span><span class="p">(</span><span class="nx">ls</span> <span class="o">&amp;&amp;</span> <span class="nx">ls</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nx">ls</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">handler</span> <span class="o">=&gt;</span> <span class="nx">handler</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">off</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">fun</span><span class="p">)</span> <span class="p">{</span> <span class="nf">del</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">fun</span><span class="p">)</span> <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">emitDelay</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">delay</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">timeout</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
      <span class="nf">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nx">timeout</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="nx">key</span><span class="p">,...</span><span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span> <span class="nx">delay</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">isOn</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="nx">notifys</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">clearNotify</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">notifys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">notifyAnys</span><span class="o">=</span> <span class="p">{}</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">[</span><span class="nx">k</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="nx">timeout</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

    </div>

    <div class="post-navigation">
        
        <div class="prev-post">
            <a href="/blog/2022/04/30/%E5%85%B7%E6%9C%89%E7%88%B6%E5%AD%90%E5%85%B3%E7%B3%BB%E7%9A%84list%E6%95%B0%E6%8D%AE%E8%BD%AC%E5%8F%98%E6%88%90tree%E5%BD%A2%E6%95%B0%E6%8D%AE%E5%AE%9E%E7%8E%B0.html">
                <span>上一篇</span>
                具有父子关系的list数据转变成tree形数据实现
            </a>
        </div>
        
        
        <div class="next-post">
            <a href="/blog/2022/08/24/nuxt%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%88%B7%E6%96%B0%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3.html">
                <span>下一篇</span>
                nuxt生产环境报错:Failed to execute 'appendChild' on 'Node'
            </a>
        </div>
        
    </div>
</article>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2026 Jessie Tang. All rights reserved.</p>
            <div class="social-links">
                <a href="https://github.com/jessietang" target="_blank">GitHub</a>
                <a href="http://weibo.com/your-weibo-id" target="_blank">微博</a>
                <a href="https://twitter.com/your-twitter-id" target="_blank">Twitter</a>
                <a href="/feed.xml" target="_blank">RSS</a>
            </div>
        </div>
    </footer>
</body>
</html>